#!/usr/bin/env ruby

require "thor"
require "hammer"
require "erb"
require "rainbow/refinement"
require "hammer/refinement"

using Rainbow
using Hammer::Refinement

class HammerCLI < Thor
  include Hammer

  class_option :extras, type: :hash, default: {}
  class_option :fullload, type: :boolean, default: false

  desc "inspect FILE", "Inspect a file and extract basic stats"
  option :stats, type: :boolean, default: false
  option :sample, type: :boolean, default: false
  def inspect(file)
    file_format = detect_format(file, extras: extras)
    dataframe = loads(file_format, filename: file, extras: extras)

    print_property "File format", file_format
    print_property("Number of records", dataframe.size) if extras.fetch("fullload", false)
    dataframe.metadata.each{|k,v| print_property(k.titlecase, v)}
    print_property "Properties", dataframe.columns.map{|p| "\n  - #{p.name} (#{p.type.yellow})"}.join

    if options[:stats]
      stats = dataframe.columns.each_with_object([]) do |col,acc|
        stat = col.stats

        unless stat.nil?
          acc << "  #{col.name} (#{col.type.yellow})"
          stat.each do |(k,v)|
            acc << "    - #{k}: #{v.to_s.cyan}"
          end
        end
      end

      print_property "Stats", "\n" + stats.join("\n") unless stats.empty?
    end

    if options[:sample]
      print_property "Content sample"
      dataframe.rows.take(5).each do |row|
        puts row.join(" | ".yellow)
      end
    end
  rescue Exception => e
    STDERR.puts "Error: #{e.message}".red
    STDERR.puts e.backtrace.join("\n").red
  end

  desc "template FILE TEMPLATE", "Process the template in the file"
  def template(file, template)
    file_format = detect_format(file, extras: extras)
    dataframe = loads(file_format, filename: file, extras: extras)
    tmpl = ERB.new template

    names = dataframe.column_names.map(&:to_sym)
    dataframe.rows.each do |row|
      ctx = Hash[names.zip(row)]
      puts tmpl.result_with_hash(ctx)
    end
  end

  no_commands {
    def extras
      @extras ||= options[:extras].merge("fullload" => options[:fullload])
    end

    def print_property(prop, value="")
      puts "#{prop.red}: #{value.to_s}"
    end
  }
end

HammerCLI.start(ARGV)
