#!/usr/bin/env ruby

require "thor"
require "hammer"
require "erb"

class HammerCLI < Thor
  include Hammer

  class_option :extras, type: :hash, default: {}

  desc "inspect FILE", "Inspect a file and extract basic stats"
  option :stats, type: :boolean, default: false
  def inspect(file)
    file_format = detect_format(file, extras: options[:extras])
    file_data = loads(file_format, filename: file, extras: options[:extras])

    puts "File format: #{file_format}"
    puts "Number of records: #{file_data.size}"
    file_data.metadata.each{|k,v| puts "#{to_title(k)}: #{v}"}
    puts "Properties: #{file_data.columns.map{|p| "\n  - #{p.name} (#{p.type})"}.join}"

    if options[:stats]
      puts "Stats:"
      file_data.columns.each do |col|
        stat = col.stats

        unless stat.nil?
          puts "  #{col.name} (#{col.type})"
          stat.each do |(k,v)|
            puts "    - #{k}: #{v}"
          end
        end
      end
    end
  rescue Exception => e
    STDERR.puts "Error: #{e.message}"
    STDERR.puts e.backtrace.join("\n")
  end

  desc "template FILE TEMPLATE", "Process the template in the file"
  def template(file, template)
    file_format = detect_format(file, extras: options[:extras])
    file_data = loads(file_format, filename: file, extras: options[:extras])
    tmpl = ERB.new template

    names = file_data.column_names.map(&:to_sym)
    file_data.rows.each do |row|
      ctx = Hash[names.zip(row)]
      puts tmpl.result_with_hash(ctx)
    end
  end

  no_commands {
    def to_title(sym)
      sym
        .to_s
        .downcase
        .split("_")
        .map{|w| "#{w[0].upcase}#{w[1..]}"}
        .join(" ")
    end
  }
end

HammerCLI.start(ARGV)
